{"version":3,"sources":["../src/addcategory_dialogue.js"],"names":["displayModal","selector","contextid","categoryid","title","Str","get_string","trigger","document","querySelector","ModalFactory","create","type","types","SAVE_CANCEL","body","getBody","large","done","modal","addEventListener","show","setSaveButtonText","root","getRoot","on","ModalEvents","hidden","setBody","modalCount","shown","append","save","e","submitForm","submitFormAjax","then","hide","location","reload","catch","error","errorcode","Notification","addNotification","message","formdata","modalid","params","id","jsonformdata","htmlBody","Fragment","loadFragment","handleFormSubmissionFailure","preventDefault","changeEvent","createEvent","initEvent","find","each","index","element","dispatchEvent","invalid","length","first","focus","formData","serialize","catcontext","value","split","parentid","name","categoryinfo","textContent","infoformat","idnumber","methodname","promise","Promise","resolve","reject","response","Ajax","call","args","parent","info","fail","resp","Number","isInteger","submit","initModal"],"mappings":"kjBA0BA,OACA,OACA,OACA,OACA,OACA,O,4lBASMA,CAAAA,CAAY,CAAG,SAACC,CAAD,CAAWC,CAAX,CAAsBC,CAAtB,CAAqC,CACxD,GAAIC,CAAAA,CAAK,CAAGC,CAAG,CAACC,UAAJ,CAAe,aAAf,CAA8B,UAA9B,CAAZ,CACE,GAAIH,CAAU,SAAd,CAA8B,CAC5BC,CAAK,CAAGC,CAAG,CAACC,UAAJ,CAAe,cAAf,CAA+B,UAA/B,CACT,CACD,GAAMC,CAAAA,CAAO,CAAGC,QAAQ,CAACC,aAAT,CAAuBR,CAAvB,CAAhB,CACAS,UAAaC,MAAb,CAAoB,CAClBC,IAAI,CAAEF,UAAaG,KAAb,CAAmBC,WADP,CAElBV,KAAK,CAAEA,CAFW,CAGlBW,IAAI,CAAEC,CAAO,CAACd,CAAD,CAAYC,CAAZ,CAHK,CAIlBc,KAAK,GAJa,CAApB,EAMCC,IAND,CAMM,SAACC,CAAD,CAAW,CACfZ,CAAO,CAACa,gBAAR,CAAyB,OAAzB,CAAkC,UAAM,CACtCD,CAAK,CAACE,IAAN,EACD,CAFD,EAGA,GAAIlB,CAAU,SAAd,CAA8B,CAC5BgB,CAAK,CAACG,iBAAN,CAAwBjB,CAAG,CAACC,UAAJ,CAAe,aAAf,CAA8B,UAA9B,CAAxB,CACD,CACD,GAAMiB,CAAAA,CAAI,CAAGJ,CAAK,CAACK,OAAN,EAAb,CACAD,CAAI,CAACE,EAAL,CAAQC,UAAYC,MAApB,CAA4B,UAAM,CAChCR,CAAK,CAACS,OAAN,CAAcZ,CAAO,CAACd,CAAD,CAAYC,CAAZ,QAAmCgB,CAAK,CAACU,UAAzC,CAArB,CACD,CAFD,EAGAN,CAAI,CAACE,EAAL,CAAQC,UAAYI,KAApB,CAA2B,UAAM,CAC/BP,CAAI,CAACQ,MAAL,CAAY,uEAAZ,CACD,CAFD,EAGAR,CAAI,CAACE,EAAL,CAAQC,UAAYM,IAApB,CAA0B,SAACC,CAAD,CAAM,CAC9BC,CAAU,CAACf,CAAD,CAAQc,CAAR,CACX,CAFD,EAGAV,CAAI,CAACE,EAAL,CAAQ,QAAR,CAAkB,MAAlB,CAA0B,SAACQ,CAAD,CAAO,CAC/BE,CAAc,CAAChB,CAAD,CAAQhB,CAAR,CAAoBD,CAApB,CAA+BiB,CAAK,CAACU,UAArC,CAAiDI,CAAjD,CAAd,CACCG,IADD,CACM,UAAM,CACVjB,CAAK,CAACkB,IAAN,GACAC,QAAQ,CAACC,MAAT,EAED,CALD,EAMCC,KAND,CAMO,SAACC,CAAD,CAAW,CAChB,GAAwB,gBAApB,GAAAA,CAAK,CAACC,SAAV,CAA0C,CACxC,MACD,CACDvB,CAAK,CAACkB,IAAN,GACAM,UAAaC,eAAb,CAA6B,CAC3BC,OAAO,CAAEJ,CAAK,CAACI,OADY,CAE3BjC,IAAI,CAAE,OAFqB,CAA7B,CAKD,CAhBD,CAiBD,CAlBD,CAmBD,CA1CD,CA2CH,C,CAWKI,CAAO,CAAG,SAACd,CAAD,CAAYC,CAAZ,CAAwB2C,CAAxB,CAAkCC,CAAlC,CAA8C,CAC1D,GAAIC,CAAAA,CAAM,CAAG,EAAb,CACA,GAAID,CAAO,SAAX,CAA2B,CACzBC,CAAM,CAACD,OAAP,CAAiBA,CAClB,CACD,GAAI5C,CAAU,SAAd,CAA8B,CAC5B6C,CAAM,CAACC,EAAP,CAAY9C,CACb,CACD,GAAI2C,CAAQ,SAAZ,CAA4B,CAC1BE,CAAM,CAACE,YAAP,CAAsBJ,CACvB,CACD,GAAMK,CAAAA,CAAQ,CAAGC,UAASC,YAAT,CAAsB,wBAAtB,CAAgD,mBAAhD,CAAqEnD,CAArE,CAAgF8C,CAAhF,CAAjB,CACA,MAAOG,CAAAA,CACV,C,CAWKG,CAA2B,CAAG,SAACnC,CAAD,CAAQjB,CAAR,CAAmBC,CAAnB,CAA+B2C,CAA/B,CAAyCC,CAAzC,CAAqD,CACvF5B,CAAK,CAACS,OAAN,CAAcZ,CAAO,CAACd,CAAD,CAAYC,CAAZ,CAAwB2C,CAAxB,CAAkCC,CAAlC,CAArB,CACD,C,CAaKZ,CAAc,CAAG,SAAChB,CAAD,CAAQhB,CAAR,CAAoBD,CAApB,CAA+B6C,CAA/B,CAAwCd,CAAxC,CAA8C,CACnEA,CAAC,CAACsB,cAAF,GACA,GAAMC,CAAAA,CAAW,CAAGhD,QAAQ,CAACiD,WAAT,CAAqB,YAArB,CAApB,CACAD,CAAW,CAACE,SAAZ,CAAsB,QAAtB,QAEAvC,CAAK,CAACK,OAAN,GAAgBmC,IAAhB,CAAqB,QAArB,EAA+BC,IAA/B,CAAoC,SAACC,CAAD,CAAQC,CAAR,CAAoB,CACtDA,CAAO,CAACC,aAAR,CAAsBP,CAAtB,CACD,CAFD,EALmE,GAS7DQ,CAAAA,CAAO,CAAG7C,CAAK,CAACK,OAAN,GAAgBmC,IAAhB,CAAqB,yBAArB,CATmD,CAU7DlB,CAAK,CAAGtB,CAAK,CAACK,OAAN,GAAgBmC,IAAhB,CAAqB,QAArB,CAVqD,CAanE,GAAIK,CAAO,CAACC,MAAR,EAAkBxB,CAAK,CAACwB,MAA5B,CAAoC,CAChCD,CAAO,CAACE,KAAR,GAAgBC,KAAhB,GACA,MACH,CAhBkE,GAkB7DC,CAAAA,CAAQ,CAAGjD,CAAK,CAACK,OAAN,GAAgBmC,IAAhB,CAAqB,MAArB,EAA6BU,SAA7B,EAlBkD,CAmB/DC,CAAU,CAAGnD,CAAK,CAACK,OAAN,GAAgBmC,IAAhB,CAAqB,YAArB,EAAmC,CAAnC,EAAsCY,KAnBY,CAoBnED,CAAU,CAAGA,CAAU,CAACE,KAAX,CAAiB,GAAjB,CAAb,CApBmE,GAqB7DC,CAAAA,CAAQ,CAAGH,CAAU,CAAC,CAAD,CArBwC,CAsB7DI,CAAI,CAAGvD,CAAK,CAACK,OAAN,GAAgBmC,IAAhB,CAAqB,UAArB,EAAiC,CAAjC,EAAoCY,KAtBkB,CAuB/DI,CAAY,CAAGxD,CAAK,CAACK,OAAN,GAAgBmC,IAAhB,CAAqB,kBAArB,EAAyC,CAAzC,CAvBgD,CAyBnE,GAAIgB,CAAY,SAAhB,CAAgC,CAE9BA,CAAY,CAAGxD,CAAK,CAACK,OAAN,GAAgBmC,IAAhB,CADN,IAAMZ,CAAN,CAAgB,UACV,EAAyB,CAAzB,EAA4B6B,WAC5C,CAHD,IAGO,CACLD,CAAY,CAAGA,CAAY,CAACC,WAC7B,CA9BkE,GA+B7DC,CAAAA,CAAU,CAAG1D,CAAK,CAACK,OAAN,GAAgBmC,IAAhB,CAAqB,iBAArB,EAAwC,CAAxC,EAA2CY,KA/BK,CAgC7DO,CAAQ,CAAG3D,CAAK,CAACK,OAAN,GAAgBmC,IAAhB,CAAqB,cAArB,EAAqC,CAArC,EAAwCY,KAhCU,CAiC/DQ,CAAU,CAAG,iDAjCkD,CAkCnE,GAAI5E,CAAU,SAAd,CAA8B,CAC5B4E,CAAU,CAAG,8CACd,CACD,GAAMC,CAAAA,CAAO,CAAG,GAAIC,CAAAA,OAAJ,CAAY,SAACC,CAAD,CAAUC,CAAV,CAAqB,CAC/C,GAAMC,CAAAA,CAAQ,CAAGC,UAAKC,IAAL,CAAU,CAAC,CAC1BP,UAAU,CAAEA,CADc,CAE1BQ,IAAI,CAAE,CAACC,MAAM,CAAEf,CAAT,CAAmBC,IAAI,CAAEA,CAAzB,CAA+Be,IAAI,CAAEd,CAArC,CAAmDE,UAAU,CAAEA,CAA/D,CAA2EC,QAAQ,CAAEA,CAArF,CAA+F7B,EAAE,CAAE9C,CAAnG,CAFoB,CAG1BuF,IAAI,CAAEpC,CAA2B,CAACnC,CAAD,CAAQjB,CAAR,CAAmBC,CAAnB,CAA+BiE,CAA/B,CAAyCrB,CAAzC,CAHP,CAAD,CAAV,CAAjB,CAKAqC,CAAQ,CAAC,CAAD,CAAR,CAAYhD,IAAZ,CAAiB,SAACuD,CAAD,CAAU,CACzB,GAAIC,MAAM,CAACC,SAAP,CAAiBF,CAAjB,CAAJ,CAA4B,CAC1BT,CAAO,EACR,CAEF,CALD,EAKG1C,KALH,CAKS,SAACC,CAAD,CAAW,CAClB0C,CAAM,CAAC1C,CAAD,CAEP,CARD,CASD,CAfe,CAAhB,CAgBA,MAAOuC,CAAAA,CACR,C,CAQK9C,CAAU,CAAG,SAACf,CAAD,CAAQc,CAAR,CAAc,CAC/BA,CAAC,CAACsB,cAAF,GACApC,CAAK,CAACK,OAAN,GAAgBmC,IAAhB,CAAqB,MAArB,EAA6BmC,MAA7B,EACD,C,aAEwB,QAAZC,CAAAA,SAAY,CAAC9F,CAAD,CAAWC,CAAX,CAAsBC,CAAtB,CAAqC,CAC5DH,CAAY,CAACC,CAAD,CAAWC,CAAX,CAAsBC,CAAtB,CACb,C","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript module for addition or edition of category as a modal form.\n * Clicking \"Add category\" or \"Edit > Edit settings\" will trigger this modal.\n *\n * @module     qbank_managecategories\n * @copyright  2021 Catalyst IT Australia Pty Ltd\n * @author     Ghaly Marc-Alexandre <marc-alexandreghaly@catalyst-ca.net>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n *\n */\n\nimport * as Str from 'core/str';\nimport Ajax from 'core/ajax';\nimport Fragment from 'core/fragment';\nimport ModalEvents from 'core/modal_events';\nimport ModalFactory from 'core/modal_factory';\nimport Notification from 'core/notification';\n\n/**\n * Function handling display of moodle form.\n *\n * @param {string} selector Selector to trigger form display on.\n * @param {int} contextid Context id for fragment.\n * @param {int} categoryid Category id for edit form and data-action.\n */\nconst displayModal = (selector, contextid, categoryid) => {\n  let title = Str.get_string('addcategory', 'question');\n    if (categoryid !== undefined) {\n      title = Str.get_string('editcategory', 'question');\n    }\n    const trigger = document.querySelector(selector);\n    ModalFactory.create({\n      type: ModalFactory.types.SAVE_CANCEL,\n      title: title,\n      body: getBody(contextid, categoryid),\n      large: true,\n    })\n    .done((modal) => {\n      trigger.addEventListener('click', () => {\n        modal.show();\n      });\n      if (categoryid === undefined) {\n        modal.setSaveButtonText(Str.get_string('addcategory', 'question'));\n      }\n      const root = modal.getRoot();\n      root.on(ModalEvents.hidden, () => {\n        modal.setBody(getBody(contextid, categoryid, undefined, modal.modalCount));\n      });\n      root.on(ModalEvents.shown, () => {\n        root.append('<style>[data-fieldtype=submit] { display: none ! important; }</style>');\n      });\n      root.on(ModalEvents.save, (e) =>{\n        submitForm(modal, e);\n      });\n      root.on('submit', 'form', (e) => {\n        submitFormAjax(modal, categoryid, contextid, modal.modalCount, e)\n        .then(() => {\n          modal.hide();\n          location.reload();\n          return;\n        })\n        .catch((error) => {\n          if (error.errorcode === \"idnumberexists\") {\n            return;\n          }\n          modal.hide();\n          Notification.addNotification({\n            message: error.message,\n            type: 'error'\n          });\n          return;\n        });\n      });\n    });\n};\n\n/**\n * Get body for moodle form from fragment new_category_form.\n *\n * @param {int} contextid Context id for fragment.\n * @param {int} categoryid Category id for edit form and data-action.\n * @param {String} formdata Data from submited form to check.\n * @param {int} modalid Id for the modal created - passed to avoid atto editor to send infos to other forms.\n * @returns {Promise}\n */\nconst getBody = (contextid, categoryid, formdata, modalid) => {\n    let params = {};\n    if (modalid !== undefined) {\n      params.modalid = modalid;\n    }\n    if (categoryid !== undefined) {\n      params.id = categoryid;\n    }\n    if (formdata !== undefined) {\n      params.jsonformdata = formdata;\n    }\n    const htmlBody = Fragment.loadFragment('qbank_managecategories', 'new_category_form', contextid, params);\n    return htmlBody;\n};\n\n/**\n * Handle form submission failure and allows checks server side.\n *\n * @param {Object} modal Object representing form data.\n * @param {int} contextid Context id for fragment.\n * @param {int} categoryid Category id for edit form and data-action.\n * @param {String} formdata Data from submited form to check.\n * @param {int} modalid Id for the modal created - passed to avoid atto editor to send infos to other forms.\n */\nconst handleFormSubmissionFailure = (modal, contextid, categoryid, formdata, modalid) => {\n  modal.setBody(getBody(contextid, categoryid, formdata, modalid));\n};\n\n/**\n * Call external function add_category_form or edit_category_form,\n * updates or insert newly added category in the question_categories table.\n *\n * @param {Object} modal Object representing form data.\n * @param {int} categoryid Category id for edit form and data-action.\n * @param {int} contextid Context id for fragment.\n * @param {int} modalid Id for the modal created - passed to avoid atto editor to send infos to other forms.\n * @param {Event} e Form submission event.\n * @returns {Promise} Resolved when successful.\n */\nconst submitFormAjax = (modal, categoryid, contextid, modalid, e) => {\n  e.preventDefault();\n  const changeEvent = document.createEvent('HTMLEvents');\n  changeEvent.initEvent('change', true, true);\n\n  modal.getRoot().find(':input').each((index, element) => {\n    element.dispatchEvent(changeEvent);\n  });\n\n  const invalid = modal.getRoot().find('[aria-invalid=\"true\"]');\n  const error = modal.getRoot().find('.error');\n\n  // If we found invalid fields, focus on the first one and do not submit via ajax.\n  if (invalid.length || error.length) {\n      invalid.first().focus();\n      return;\n  }\n\n  const formData = modal.getRoot().find('form').serialize();\n  let catcontext = modal.getRoot().find('#id_parent')[0].value;\n  catcontext = catcontext.split(',');\n  const parentid = catcontext[0];\n  const name = modal.getRoot().find('#id_name')[0].value;\n  let categoryinfo = modal.getRoot().find('#id_infoeditable')[0];\n  // Handles any change of id when idnumber exists or missing name;\n  if (categoryinfo === undefined) {\n    let id = '#' + modalid + 'editable';\n    categoryinfo = modal.getRoot().find(id)[0].textContent;\n  } else {\n    categoryinfo = categoryinfo.textContent;\n  }\n  const infoformat = modal.getRoot().find('#menuinfoformat')[0].value;\n  const idnumber = modal.getRoot().find('#id_idnumber')[0].value;\n  let methodname = 'qbank_managecategories_update_question_category';\n  if (categoryid === undefined) {\n    methodname = 'qbank_managecategories_add_question_category';\n  }\n  const promise = new Promise((resolve, reject) => {\n    const response = Ajax.call([{\n      methodname: methodname,\n      args: {parent: parentid, name: name, info: categoryinfo, infoformat: infoformat, idnumber: idnumber, id: categoryid},\n      fail: handleFormSubmissionFailure(modal, contextid, categoryid, formData, modalid)\n    }]);\n    response[0].then((resp) => {\n      if (Number.isInteger(resp)) {\n        resolve();\n      }\n      return;\n    }).catch((error) => {\n      reject(error);\n      return;\n    });\n  });\n  return promise;\n};\n\n/**\n * This triggers a form submission, so that any mform elements can do final tricks before the form submission is processed.\n *\n * @param {Object} modal representing form data.\n * @param {Event} e Form submission event.\n */\nconst submitForm = (modal, e) => {\n  e.preventDefault();\n  modal.getRoot().find('form').submit();\n};\n\nexport const initModal = (selector, contextid, categoryid) => {\n  displayModal(selector, contextid, categoryid);\n};\n"],"file":"addcategory_dialogue.min.js"}