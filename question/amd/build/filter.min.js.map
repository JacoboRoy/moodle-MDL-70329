{"version":3,"sources":["../src/filter.js"],"names":["init","filterRegionId","defaultcourseid","defaultcategoryid","perpage","recurse","showhidden","qbshowtext","wsfilter","filterverb","filters","qperpage","qpage","SELECTORS","QUESTION_CONTAINER_ID","DEFAULT_PAGED_CONTENT_CONFIG","ignoreControlWhileLoading","controlPlacementBottom","TEMPLATE_NAME","CoreFilter","filterdata","pendingPromise","applyFilter","requestQuestions","filter","ajax","call","methodname","args","Object","entries","key","value","jointype","values","toString","push","then","response","console","log","totalquestions","firstpagehtml","html","renderPagination","js","questionscontainer","document","getElementById","Templates","replaceNodeContents","resolve","fail","Notification","exception","PagedContentFactory","createFromAjax","pagesData","map","pageData","pageNumber","render"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Question bank filter managemnet.\n *\n * @module     core_question/filter\n * @copyright  2021 Tomo Tsuyuki <tomotsuyuki@catalyst-au.net>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as CoreFilter from 'core/filter';\nimport ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport PagedContentFactory from 'core/paged_content_factory';\n\n/**\n * Initialise the question bank filter on the element with the given id.\n *\n * @param {String} filterRegionId id of the filter region\n * @param {String} defaultcourseid default course id\n * @param {String} defaultcategoryid default category id\n * @param {int} perpage number of question per page\n * @param {boolean} recurse if loading sub categories\n * @param {boolean} showhidden if loading hidden question\n * @param {boolean} qbshowtext if loading question text\n */\nexport const init = (filterRegionId, defaultcourseid, defaultcategoryid,\n                     perpage, recurse, showhidden, qbshowtext) => {\n\n    // Default filter params for WS function.\n    let wsfilter = {\n        // Default value filterset::JOINTYPE_DEFAULT.\n        filterverb: 2,\n        filters: [],\n        defaultcourseid: defaultcourseid,\n        defaultcategoryid: defaultcategoryid,\n        qperpage: perpage,\n        qpage: 0,\n        qbshowtext: qbshowtext,\n        recurse: recurse,\n        showhidden: showhidden,\n    };\n\n    // HTML <div> ID of question container.\n    var SELECTORS = {\n        QUESTION_CONTAINER_ID: 'questionscontainer',\n    };\n\n    // Default Pagination config.\n    var DEFAULT_PAGED_CONTENT_CONFIG = {\n        ignoreControlWhileLoading: true,\n        controlPlacementBottom: false,\n    };\n\n    // Template to renden return value from ws function.\n    var TEMPLATE_NAME = 'core_question/qbank_questions';\n\n    // Init function with apply callback.\n    CoreFilter.init(filterRegionId, 'QbankTable', function(filterdata, pendingPromise) {\n        applyFilter(filterdata, pendingPromise);\n    });\n\n    /**\n     * Ajax call to retrieve question via ws functions\n     *\n     * @returns {*}\n     * @param {Object} filter filter object\n     */\n    var requestQuestions = function(filter) {\n        let request = {methodname: 'core_qbank_get_questions', args: filter};\n        return ajax.call([request])[0];\n    };\n\n    /**\n     * Retrieve table data.\n     *\n     * @param {Object} filter data\n     * @param {int} filterverb outermost join types\n     * @param {Promise} filter pending promise\n     */\n    const applyFilter = (filterdata, filterverb, pendingPromise) => {\n        // Getting filter data.\n        // Otherwise, the ws function should retrieves question based on default courseid and cateogryid.\n        if (filterdata) {\n            // Main join types.\n            wsfilter['filterverb'] = filterverb;\n\n            // Clean old filter\n            wsfilter['filters'] = [];\n\n            // Retrieve fitter info.\n            for (const [key, value] of Object.entries(filterdata)) {\n                let filter = {'filtertype': key, 'jointype': value.jointype, 'values': value.values.toString()};\n                wsfilter['filters'].push(filter);\n            }\n        }\n\n        // Load questions for first page.\n        requestQuestions(wsfilter)\n            .then(function(response) {\n                console.log(response);\n                let totalquestions = response.totalquestions;\n                let firstpagehtml = response.html;\n                return renderPagination(wsfilter, totalquestions, firstpagehtml);\n            })\n            // Render questions for first page and pagination.\n            .then(function(html, js) {\n                console.log(html);\n                console.log(js);\n                let questionscontainer = document.getElementById(SELECTORS.QUESTION_CONTAINER_ID);\n                Templates.replaceNodeContents(questionscontainer, html, js);\n                // Resolve filter promise.\n                if (pendingPromise) {\n                    pendingPromise.resolve();\n                }\n                return;\n            })\n            .fail(Notification.exception);\n    };\n\n    /**\n     * Render table and pagination.\n     *\n     * @param {Object} filter params\n     * @param {int} totalquestions\n     * @param {string} firstpagehtml\n     */\n    const renderPagination = (filter, totalquestions, firstpagehtml) => {\n        return PagedContentFactory.createFromAjax(\n            totalquestions,\n            perpage,\n            function(pagesData) {\n                return pagesData.map(function(pageData) {\n                    let pageNumber = pageData.pageNumber;\n                    // Page number start at 1.\n                    let qpage = pageNumber - 1;\n\n                    // Render first page\n                    if (qpage == 0) {\n                        return Templates.render(TEMPLATE_NAME, {html: firstpagehtml});\n                    } else {\n                        // Load data for selected page.\n                        filter['qpage'] = qpage;\n                        return requestQuestions(filter)\n                        .then(function(response) {\n                            return Templates.render(TEMPLATE_NAME, {html: response.html});\n                        })\n                        .fail(Notification.exception);\n                    }\n                });\n            },\n            DEFAULT_PAGED_CONTENT_CONFIG\n        );\n    };\n\n    // Run apply filter at page load.\n    applyFilter();\n};\n"],"file":"filter.min.js"}